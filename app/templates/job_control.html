{% extends "layout.html" %}

{% block title %}Job Control{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/job_control.css') }}">
{% endblock %}

{% block content %}
<div class="body-content">
  <div class="job-control-container">
    <!-- Job Header -->
    <div class="job-header">
      <h2>{{ job.job_description }}</h2>
      <div class="vehicle-info">
        <p><strong>Vehicle:</strong> {{ job.vehicle_make }} {{ job.vehicle_model }}</p>
        <p><strong>Registration:</strong> {{ job.vehicle_registration }}</p>
        <p><strong>Customer:</strong> {{ job.customer.full_name }}</p>
        <p><strong>Cost:</strong> {{ job.total_cost }}</p>
        <p><strong>Status:</strong> <span id="jobStatusLabel">{{ job.status }}</span></p>
      </div>
    </div>

    <!-- Timer Section -->
    <div class="timer-section">
      <div class="timer-box">
        <p>Elapsed Time</p>
        <span id="liveTimer">00:00:00</span>
      </div>
      <div class="timer-box">
        <p>Current Time</p>
        <span id="currentTime">--:--:--</span>
      </div>
      <div class="timer-box">
        <p>Target Duration</p>
        <span>
          {% if job.target_duration %}
          {% set total_seconds = job.target_duration*60 %}
          {% set days = total_seconds // 86400 %}
          {% set hours = (total_seconds % 86400) // 3600 %}
          {% set minutes = (total_seconds % 3600) // 60 %}
          {{ days }}d {{ hours }}h {{ minutes }}m
          {% else %}
          1d 1h 30m
          {% endif %}
        </span>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button id="startButton" class="action-button start-button">Start Job</button>

      <div class="pause-container">
        <button id="pauseButton" class="action-button pause-button">Pause Job</button>
        <div id="pauseReasonBox" style="display:none; margin-top:5px;">
          <input type="text" id="pauseReasonInput" placeholder="Enter reason">
          <button id="confirmPauseBtn" class="btn-confirm-pause">Confirm Pause</button>
        </div>
      </div>

      <button id="resumeButton" class="action-button resume-button">Resume Job</button>
      <button id="stopButton" class="action-button stop-button">Stop Job</button>
    </div>

    <!-- Pause / Resume History -->
    <div class="history-section">
      <h3>Pause / Resume History</h3>
      <ul class="history-list" id="pauseHistoryList">
        {% for p in job.pause_logs %}
        {% set seconds = p.duration_seconds() %}
        <li>
          Paused: {{ p.pause_start }} |
          Timer: {{ "%02d:%02d:%02d"|format(seconds // 3600, (seconds % 3600)//60, seconds % 60) }} |
          Resumed: {{ p.pause_end or 'Not resumed yet' }} |
          Reason: {{ p.reason }}
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<!-- Hidden fields -->
<input type="hidden" id="initialElapsed" value="{{ job.total_work_duration or 0 }}">
<input type="hidden" id="jobStatus" value="{{ job.status }}">
<input type="hidden" id="jobStartTime" value="{{ job.start_time.timestamp() if job.start_time else '' }}">
<input type="hidden" id="jobId" value="{{ job.id }}">

{% endblock %}

{% block extra_js %}
<script>
  // ===== Elements =====
  const liveTimer = document.getElementById('liveTimer');
  const currentTimeSpan = document.getElementById('currentTime');
  const startButton = document.getElementById('startButton');
  const pauseButton = document.getElementById('pauseButton');
  const resumeButton = document.getElementById('resumeButton');
  const stopButton = document.getElementById('stopButton');
  const pauseBox = document.getElementById('pauseReasonBox');
  const pauseInput = document.getElementById('pauseReasonInput');
  const confirmPauseBtn = document.getElementById('confirmPauseBtn');
  const jobStatusLabel = document.getElementById('jobStatusLabel');
  const historyList = document.getElementById('pauseHistoryList');

  // ===== Timer Variables =====
  let elapsedSeconds = parseInt(document.getElementById('initialElapsed').value) || 0;
  let startTime = parseFloat(document.getElementById('jobStartTime').value) || null;
  let timerInterval = null;
  let jobStatus = document.getElementById('jobStatus').value;
  let jobRunning = ["Running", "In Progress"].includes(jobStatus);
  let pauseActive = (jobStatus === "Paused");

  // Disable buttons if job already stopped
  if (["Waiting for Approval", "Completed"].includes(jobStatus)) {
    startButton.disabled = true;
    pauseButton.disabled = true;
    resumeButton.disabled = true;
    stopButton.disabled = true;
  }

  // ===== Format time =====
  function formatTime(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }

  // ===== Update Timer =====
  function updateTimer() {
    liveTimer.textContent = formatTime(elapsedSeconds);
  }

  // ===== Update Current Time =====
  function updateCurrentTime() {
    currentTimeSpan.textContent = new Date().toLocaleTimeString();
  }
  setInterval(updateCurrentTime, 1000);

  // ===== Timer Loop =====
  function startTimer() {
    if (startTime) {
      const now = Date.now() / 1000;
      elapsedSeconds += Math.floor(now - startTime);
      startTime = Date.now() / 1000;
    } else {
      startTime = Date.now() / 1000;
    }

    timerInterval = setInterval(() => {
      elapsedSeconds++;
      updateTimer();
    }, 1000);
  }

  // ===== Initialize Timer =====
  if (jobRunning) {
    startButton.disabled = true;
    pauseButton.disabled = false;
    resumeButton.disabled = true;
    stopButton.disabled = false;
    startTimer();
  }

  // ===== Start Job =====
  startButton.onclick = () => {
    if (jobRunning) return;
    jobRunning = true;
    startButton.disabled = true;
    pauseButton.disabled = false;
    resumeButton.disabled = true;
    stopButton.disabled = false;
    jobStatusLabel.textContent = "Running";
    startTime = Date.now() / 1000;
    startTimer();
  };

  // ===== Pause Job =====
  pauseButton.onclick = () => { pauseBox.style.display = "block"; };

  confirmPauseBtn.onclick = () => {
    const reason = pauseInput.value.trim();
    if (!reason) return alert("Enter reason!");
    if (!jobRunning) return;

    pauseActive = true;
    pauseBox.style.display = "none";
    resumeButton.disabled = false;
    pauseButton.disabled = true;
    clearInterval(timerInterval);
    startTime = null;

    const now = new Date();
    const li = document.createElement('li');
    li.textContent = `Paused because '${reason}' at ${now.toLocaleTimeString()}, elapsed: ${formatTime(elapsedSeconds)}`;
    historyList.appendChild(li);

    jobStatusLabel.textContent = "Paused";
    pauseInput.value = "";
  };

  // ===== Resume Job =====
  resumeButton.onclick = () => {
    if (!pauseActive) return alert("Job is not paused!");
    pauseActive = false;
    pauseButton.disabled = false;
    resumeButton.disabled = true;
    jobStatusLabel.textContent = "In Progress";

    startTime = Date.now() / 1000;
    startTimer();

    const now = new Date();
    const li = document.createElement('li');
    li.textContent = `Resumed at ${now.toLocaleTimeString()}`;
    historyList.appendChild(li);
  };

  // ===== Stop Job =====
  stopButton.onclick = () => {
    if (!jobRunning) return;
    jobRunning = false;
    pauseActive = false;
    clearInterval(timerInterval);
    startTime = null;
    jobStatusLabel.textContent = "Waiting for Approval";

    startButton.disabled = true;
    pauseButton.disabled = true;
    resumeButton.disabled = true;
    stopButton.disabled = true;

    const now = new Date();
    const li = document.createElement('li');
    li.textContent = `Job stopped at ${now.toLocaleTimeString()}, total elapsed: ${formatTime(elapsedSeconds)}`;
    historyList.appendChild(li);

    setTimeout(() => {
      window.location.href = "{{ url_for('main.staff_jobs', tech_id=job.technician.id) }}";
    }, 500);
  };

  // ===== Initialize =====
  updateTimer();
</script>
{% endblock %}