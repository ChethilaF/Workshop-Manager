{% extends "layout.html" %}
{% block title %}Job Control{% endblock %}

{% block extra_css %}
<!-- Page-specific CSS for job control -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/job_control.css') }}">
{% endblock %}

{% block content %}
<div class="body-content">
  <div class="job-control-container">

    <!-- Job Information Section -->
    <div class="job-header">
      <h2>{{ job.description }}</h2>
      <div class="vehicle-info">
        <p><strong>Vehicle:</strong> {{ job.vehicle_make }} {{ job.vehicle_model }}</p>
        <p><strong>Registration:</strong> {{ job.vehicle_registration }}</p>
        <p><strong>Customer:</strong> {{ job.customer.name }}</p>
        <p><strong>Cost:</strong> {{ job.cost }}</p>
        <p><strong>Status:</strong> <span id="jobStatusLabel">{{ job.status }}</span></p>
      </div>
    </div>

    <!-- Timer and Progress Section -->
    <div class="timer-section">
      <div class="timer-box">
        <p>Elapsed Time</p>
        <span id="liveTimer">00:00:00</span>
      </div>
      <div class="timer-box">
        <p>Current Time</p>
        <span id="currentTime">--:--:--</span>
      </div>
      <div class="timer-box">
        <p>Target Duration</p>
        <span>
          {% if job.target_duration_seconds %}
          {% set total_seconds = job.target_duration_seconds %}
          {% set days = total_seconds // 86400 %}
          {% set hours = (total_seconds % 86400) // 3600 %}
          {% set minutes = (total_seconds % 3600) // 60 %}
          {{ days }}d {{ hours }}h {{ minutes }}m
          {% else %}
          1d 1h 30m
          {% endif %}
        </span>
      </div>
      <!-- Progress bar visualizing elapsed time vs target -->
      <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <!-- Start Job -->
      <form action="{{ url_for('main.start_job', job_id=job.id) }}" method="POST">
        <button id="startButton" class="action-button start-button" {% if job.status in ['Running','In Progress']
          %}disabled{% endif %}>
          <i class="fa fa-play"></i> Start Job
        </button>
      </form>

      <!-- Pause Job with reason -->
      <div class="pause-container">
        <form action="{{ url_for('main.pause_job', job_id=job.id) }}" method="POST">
          <button type="button" class="action-button pause-button" onclick="togglePauseBox()">
            Pause Job
          </button>
          <div id="pauseReasonBox" class="pause-reason-box">
            <input type="text" name="reason" placeholder="Enter reason" required>
            <button type="submit" class="btn-confirm-pause">Confirm Pause</button>
          </div>
        </form>
      </div>

      <!-- Resume Job -->
      <form action="{{ url_for('main.resume_job', job_id=job.id) }}" method="POST">
        <button id="resumeButton" class="action-button resume-button">
          <i class="fa fa-play-circle"></i> Resume Job
        </button>
      </form>

      <!-- Stop Job -->
      <form action="{{ url_for('main.stop_job', job_id=job.id) }}" method="POST">
        <button id="stopButton" class="action-button stop-button">
          <i class="fa fa-stop-circle"></i> Stop Job
        </button>
      </form>
    </div>

    <!-- Pause / Resume History -->
    <div class="history-section">
      <h3>Pause / Resume History</h3>
      {% if job.pauses %}
      <ul class="history-list">
        {% for p in job.pauses %}
        <li>
          <strong>Paused:</strong> {{ p.paused_at }} |
          <strong>Timer:</strong> {{ "%02d:%02d:%02d"|format(p.timer_value // 3600, (p.timer_value % 3600)//60,
          p.timer_value % 60) }} |
          <strong>Resumed:</strong> {{ p.resumed_at if p.resumed_at else 'Not resumed yet' }} |
          <strong>Reason:</strong> {{ p.reason }}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No pauses recorded.</p>
      {% endif %}
    </div>

  </div>
</div>

<!-- Hidden fields to pass data to JS -->
<input type="hidden" id="initialElapsed" value="{{ job.total_work_duration or 0 }}">
<input type="hidden" id="targetSeconds" value="{{ job.target_duration_seconds or 5400 }}">
<input type="hidden" id="jobStartTime" value="{{ job.start_time | tojson }}">

<!-- Job Control JavaScript -->
<script>
  // Get hidden values from template
  let elapsedSeconds = parseInt(document.getElementById('initialElapsed').value); // total previous work
  const targetSeconds = parseInt(document.getElementById('targetSeconds').value); // total target duration in seconds
  const liveTimer = document.getElementById('liveTimer');
  const progressBar = document.getElementById('progressBar');
  const jobStatusLabel = document.getElementById('jobStatusLabel');
  const startButton = document.getElementById('startButton');
  const jobStartStr = document.getElementById('jobStartTime').value;
  let jobStart = jobStartStr ? new Date(jobStartStr) : null;
  let timerInterval = null;

  // Format seconds to d:h:m:s
  function formatTime(seconds) {
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    let str = '';
    if (d > 0) str += `${d}d `;
    if (h > 0 || d > 0) str += `${h}h `;
    if (m > 0 || h > 0 || d > 0) str += `${m}m `;
    str += `${s}s`;
    return str;
  }

  // Update timer and progress bar
  function updateTimer() {
    let total = elapsedSeconds;
    if (jobStart) {
      total += Math.floor((new Date() - jobStart) / 1000);
    }

    // Update live timer text
    liveTimer.innerText = formatTime(total);

    // Update progress bar width
    let percent = Math.min(100, (total / targetSeconds) * 100);
    progressBar.style.width = percent + '%';

    // Change bar color if over target
    progressBar.style.backgroundColor = total > targetSeconds ? 'red' : '#00c8df';
  }

  // Start the timer
  function startTimer() {
    if (timerInterval) return;
    if (!jobStart) jobStart = new Date();
    startButton.disabled = true;
    jobStatusLabel.innerText = 'Running';
    timerInterval = setInterval(updateTimer, 1000);
  }

  // Pause timer (without resetting elapsedSeconds)
  function pauseTimer() {
    if (jobStart) {
      elapsedSeconds += Math.floor((new Date() - jobStart) / 1000);
      jobStart = null;
    }
    clearInterval(timerInterval);
    timerInterval = null;
  }

  // Resume timer
  function resumeTimer() {
    if (!jobStart) jobStart = new Date();
    if (!timerInterval) timerInterval = setInterval(updateTimer, 1000);
    jobStatusLabel.innerText = 'In Progress';
  }

  // Toggle pause reason input
  function togglePauseBox() {
    const box = document.getElementById('pauseReasonBox');
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
  }

  // Update current time display
  const currentTimeSpan = document.getElementById('currentTime');
  setInterval(() => {
    currentTimeSpan.innerText = new Date().toLocaleTimeString();
  }, 1000);

  // Auto-start timer if job already running
  if (["Running", "In Progress"].includes("{{ job.status }}")) {
    resumeTimer();
  }

  // Initial update
  updateTimer();
</script>
{% endblock %}