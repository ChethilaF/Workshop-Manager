{% extends "layout.html" %}

{% block extra_css %}
<!-- Page-specific CSS for staff dashboard layout -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_dashboard.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block title %}Staff Dashboard{% endblock %}

{% block content %}
<h2>Staff</h2>

<!-- Notification controls -->
<div class="notification-controls">
  <!-- Button to enable push notifications -->
  <button id="enableNotifications" class="notify-btn enable" title="Enable Notifications">
    <i class="fas fa-bell"></i>
  </button>
  <!-- Button to disable push notifications (hidden initially) -->
  <button id="disableNotifications" class="notify-btn disable" title="Disable Notifications" style="display:none;">
    <i class="fas fa-bell-slash"></i>
  </button>
</div>

<!-- Grid of technician buttons -->
<div class="tech-grid">
  {% for tech in techs %}
    <!-- Each technician is a button inside a form that routes to their jobs page -->
    <form action="{{ url_for('main.staff_jobs', tech_id=tech.id) }}" method="get">
      <button type="submit" class="tech-circle" aria-label="View jobs for {{ tech.name }}">
        {{ tech.name }}
      </button>
    </form>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

  const enableBtn = document.getElementById("enableNotifications");
  const disableBtn = document.getElementById("disableNotifications");

  if (!enableBtn || !disableBtn) return;

  // Helper: convert VAPID key
  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = window.atob(base64);
    return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
  }

  // Update buttons based on subscription
  async function updateButtons() {
    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      if (subscription) {
        enableBtn.style.display = "none";
        disableBtn.style.display = "inline-block";
      } else {
        enableBtn.style.display = "inline-block";
        disableBtn.style.display = "none";
      }
    } catch (err) {
      console.error("Error checking push subscription:", err);
    }
  }

  // Enable notifications
  async function enableNotifications() {
    try {
      const perm = await Notification.requestPermission();
      if (perm !== "granted") {
        alert("Notifications permission denied.");
        return;
      }

      const registration = await navigator.serviceWorker.register("/service-worker.js");
      const vapidKey = "{{ vapid_public_key|safe }}";

      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidKey)
      });

      await fetch("/save-subscription", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(subscription)
      });

      updateButtons();
      alert("Notifications enabled!");
    } catch (err) {
      console.error("Failed to enable notifications:", err);
      alert("Error enabling notifications.");
    }
  }

  // Disable notifications
  async function disableNotificationsFunc() {
    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      if (subscription) {
        await fetch("/unsubscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(subscription)
        });
        await subscription.unsubscribe();
      }

      updateButtons();
      alert("Notifications disabled!");
    } catch (err) {
      console.error("Failed to disable notifications:", err);
      alert("Error disabling notifications.");
    }
  }

  // Event listeners
  enableBtn.addEventListener("click", enableNotifications);
  disableBtn.addEventListener("click", disableNotificationsFunc);

  // Initial button state
  updateButtons();

});
</script>
{% endblock %}

