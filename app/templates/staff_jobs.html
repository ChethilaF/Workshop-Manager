{% extends "layout.html" %}

{% block title %}My Jobs{% endblock %}

{% block extra_css %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Staff Jobs specific CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_jobs.css') }}">
{% endblock %}

{% block content %}
<h2>Jobs for {{ technician.name }}</h2>

{% if jobs %}
<ul class="jobs-list">
  {% for job in jobs %}
  <li class="job-card 
      {% if job.status == 'Declined' %}declined{% elif job.status == 'Accepted' %}accepted{% else %}waiting{% endif %}">

    <!-- Job Description -->
    <div class="job-info">
      <div class="job-description" aria-label="Job description">{{ job.job_description }}</div>

      <!-- Job Details -->
      <small><i class="fas fa-tasks"></i> Status - {{ job.status }}</small>
      <small><i class="fas fa-car"></i> Vehicle Rego - {{ job.vehicle_registration }}</small>
      <small><i class="fas fa-car-side"></i> Vehicle - {{ job.vehicle_make }} {{ job.vehicle_model }} {{ job.vehicle_year }}</small>
      <small>
        <i class="fas fa-clock"></i> Target Duration -
        {% if job.target_duration %}
          {% set duration = job.target_duration|int %}
          {% set h = duration // 60 %}
          {% set m = duration % 60 %}
          {% if h > 0 %}{{ h }} hr{% endif %}{% if m > 0 %} {{ m }} min{% endif %}
        {% else %}
          N/A
        {% endif %}
      </small>
      <small><i class="fas fa-user"></i> Customer - {{ job.customer.full_name }}</small>
      <small><i class="fas fa-calendar-alt"></i> Start - {{ job.start_time or 'N/A' }}</small>
      <small><i class="fas fa-calendar-check"></i> End - {{ job.end_time or 'N/A' }}</small>
    </div>

    <!-- Job Actions -->
    <div class="job-actions">
      {% if current_user.role != 'admin' %}
          {% if job.status == 'Waiting' or job.status is none %}
            <!-- Accept Job -->
            <form method="POST" action="{{ url_for('main.accept_job', job_id=job.id) }}">
              <button type="submit" class="accept-button" aria-label="Accept job {{ job.job_description }}">
                <i class="fas fa-check"></i> Accept
              </button>
            </form>

            <!-- Decline Job -->
            <form method="POST" action="{{ url_for('main.decline_job', job_id=job.id) }}">
              <button type="submit" class="decline-button" aria-label="Decline job {{ job.job_description }}">
                <i class="fas fa-times"></i> Decline
              </button>
            </form>

          {% elif job.status == 'Declined' %}
            <!-- Declined Status -->
            <div class="status-box declined">
              <i class="fas fa-times-circle"></i> Declined — waiting for admin action
            </div>

          {% elif job.status in ['Accepted', 'Running', 'In Progress', 'Paused'] %}
            <!-- Enter Job Control -->
            <a href="{{ url_for('main.job_control', job_id=job.id) }}" class="control-button"
              aria-label="Control job {{ job.job_description }}">
              <i class="fas fa-cogs"></i> Enter Job Control
            </a>
          {% endif %}
      {% else %}
          <!-- Admin view: show status but no action buttons -->
          {% if job.status == 'Declined' %}
          <div class="status-box declined">
            <i class="fas fa-times-circle"></i> Declined — waiting for admin action
          </div>
          {% elif job.status in ['Accepted', 'Running', 'In Progress', 'Paused', 'Waiting', None] %}
          <div class="status-box waiting">
            <i class="fas fa-info-circle"></i> {{ job.status or 'Waiting' }}
          </div>
          {% endif %}
      {% endif %}
    </div>

  </li>
  {% endfor %}
</ul>
{% else %}
<p>No jobs assigned to you.</p>
{% endif %}
{% endblock %}
